# TRD: 연구실 케이지 관리 서비스

> **문서 버전**: v1.0  
> **작성일**: 2026-01-18  
> **상태**: 초안

---

## 1. 시스템 아키텍처

### 1.1 전체 구조

```
┌─────────────────────────────────────────────────────────────┐
│                        클라이언트                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   PC 웹     │  │  태블릿 웹   │  │  모바일 웹   │         │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘         │
└─────────┼────────────────┼────────────────┼─────────────────┘
          │                │                │
          └────────────────┼────────────────┘
                           │ HTTPS
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                    프론트엔드 (Vercel)                       │
│                     React + Vite                            │
│           정적 파일 호스팅 + API 프록시                        │
└─────────────────────────┬───────────────────────────────────┘
                          │ HTTPS (REST API)
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                  백엔드 (Railway/Fly.io)                     │
│                      FastAPI (Python)                       │
│  ┌───────────┐  ┌───────────┐  ┌───────────┐               │
│  │  인증 API  │  │ 케이지 API │  │ 리포트 API │               │
│  └───────────┘  └───────────┘  └───────────┘               │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                   데이터베이스 (SQLite)                       │
│                   파일 기반, 서버 내장                        │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 데이터 흐름

```
[연구원] ──더블클릭──▶ [React] ──POST /api/cages/{id}/assign──▶ [FastAPI]
                                                                    │
    ◀──UI 업데이트──── [React] ◀──{success, version}──────────────┘
                          │
                          │ (3~5초 폴링)
                          ▼
                   GET /api/cages?rack_id=1
                          │
    ◀──최신 데이터 반영── [React] ◀──{cages: [...]}────────────────┘
```

---

## 2. 기술 스택

### 2.1 프론트엔드

| 구분 | 선택 | 선택 이유 | 대안 | 벤더 락인 |
|------|------|-----------|------|-----------|
| **프레임워크** | React 18 | 그리드 UI 라이브러리 풍부, 커뮤니티 활발 | Vue, Svelte | 낮음 |
| **빌드 도구** | Vite | 빠른 개발 서버, 간단한 설정 | Webpack, Next.js | 낮음 |
| **스타일링** | CSS Modules | 컴포넌트 스코프, 번들 최적화 | Tailwind, Styled-components | 낮음 |
| **HTTP 클라이언트** | Axios | 인터셉터, 에러 처리 편리 | Fetch API | 낮음 |
| **상태 관리** | React Context + useReducer | 소규모 앱에 충분, 추가 의존성 없음 | Redux, Zustand | 낮음 |

### 2.2 백엔드

| 구분 | 선택 | 선택 이유 | 대안 | 벤더 락인 |
|------|------|-----------|------|-----------|
| **프레임워크** | FastAPI | 사용자 선호, 자동 문서화, 타입 힌트 | Flask, Django | 낮음 |
| **언어** | Python 3.11+ | 학습 용이, 데이터 처리 강점 | Node.js, Go | 낮음 |
| **ORM** | SQLAlchemy 2.0 | SQLite 호환, 타입 힌트 지원 | Tortoise ORM, raw SQL | 낮음 |
| **유효성 검사** | Pydantic | FastAPI 기본 통합, 타입 안전 | Marshmallow | 낮음 |
| **인증** | python-jose + passlib | JWT 토큰 기반 인증 | AuthLib | 낮음 |

### 2.3 데이터베이스

| 구분 | 선택 | 선택 이유 | 대안 | 벤더 락인 |
|------|------|-----------|------|-----------|
| **DBMS** | SQLite 3 | 소규모에 최적, 서버 없이 동작, 단순 | PostgreSQL, MySQL | 낮음 |
| **마이그레이션** | Alembic | SQLAlchemy 공식 툴 | 수동 마이그레이션 | 낮음 |

> [!NOTE]
> SQLite는 동시 쓰기에 제한이 있으나, 동시 접속 ~5명 규모에서는 문제 없음. WAL 모드 활성화로 읽기/쓰기 병렬 처리 개선.

### 2.4 배포/호스팅

| 구분 | 선택 | 예상 비용 | 확장 전략 |
|------|------|-----------|-----------|
| **프론트엔드** | Vercel | 무료 (취미 티어) | 자동 CDN, 무제한 대역폭 |
| **백엔드** | Railway / Fly.io | 무료 (취미) ~ $5/월 | 컨테이너 스케일업 |
| **DB 백업** | Railway 볼륨 / Fly.io 볼륨 | 포함 | 정기 백업 스크립트 |

### 2.5 외부 API/서비스

| 서비스 | 용도 | MVP 포함 | 대체 옵션 |
|--------|------|----------|-----------|
| 구글 OAuth | 소셜 로그인 | ❌ 후순위 | 카카오, 네이버 |
| SendGrid / Resend | 이메일 알림 | ❌ 후순위 | Mailgun, AWS SES |
| Slack Webhook | 슬랙 알림 | ❌ 후순위 | Discord, Teams |

---

## 3. 비기능적 요구사항

### 3.1 성능

| 항목 | 목표 | 측정 방법 |
|------|------|-----------|
| **페이지 로드** | 3초 이내 (3G 기준) | Lighthouse |
| **API 응답** | 200ms 이내 (p95) | 서버 로그 |
| **폴링 주기** | 3~5초 | 설정값 |

### 3.2 보안

| 항목 | 구현 방법 |
|------|-----------|
| **인증** | JWT 토큰 (Access 15분 + Refresh 7일) |
| **비밀번호** | bcrypt 해싱 (cost=12) |
| **HTTPS** | 필수 (Vercel/Railway 기본 제공) |
| **CORS** | 화이트리스트 도메인만 허용 |
| **SQL Injection** | SQLAlchemy ORM 사용으로 방지 |
| **XSS** | React 자동 이스케이프 |

### 3.3 확장성

| 시나리오 | 대응 |
|----------|------|
| 동시 접속 20명+ | PostgreSQL 전환 검토 |
| 데이터 100만 건+ | 인덱싱 최적화, 파티셔닝 |
| 멀티 센터 | 멀티테넌트 아키텍처 재설계 필요 |

### 3.4 가용성

| 항목 | 목표 |
|------|------|
| **업타임** | 99% (월 7시간 다운타임 허용) |
| **백업** | 일 1회 자동 백업 |
| **복구** | 1시간 내 복구 (RTO) |

---

## 4. 동시성 처리 (Optimistic Locking)

### 4.1 개념

```
┌─────────────────────────────────────────────────────┐
│                    정상 흐름                         │
├─────────────────────────────────────────────────────┤
│ 1. 연구원 A: GET /cages → version=1                 │
│ 2. 연구원 A: PUT /cages/5 (version=1) → ✅ 저장     │
│ 3. 서버: version 1→2 증가                           │
└─────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────┐
│                    충돌 흐름                         │
├─────────────────────────────────────────────────────┤
│ 1. 연구원 A: GET /cages → version=1                 │
│ 2. 연구원 B: GET /cages → version=1                 │
│ 3. 연구원 B: PUT /cages/5 (version=1) → ✅ 저장     │
│ 4. 서버: version 1→2                                │
│ 5. 연구원 A: PUT /cages/5 (version=1) → ❌ 충돌     │
│ 6. 연구원 A: "다른 사용자가 수정했습니다" 알림        │
│ 7. 연구원 A: 자동 새로고침 → version=2 획득          │
└─────────────────────────────────────────────────────┘
```

### 4.2 구현 방식

| 구성요소 | 설명 |
|----------|------|
| **버전 필드** | `cages.version` (INTEGER, 기본값 1) |
| **업데이트 조건** | `WHERE id = ? AND version = ?` |
| **충돌 응답** | HTTP 409 Conflict |
| **클라이언트 처리** | 409 수신 시 알림 표시 + 자동 폴링 |

---

## 5. 데이터베이스 요구사항

### 5.1 스키마 설계 원칙

| 원칙 | 설명 |
|------|------|
| **정규화** | 3NF 수준 유지 |
| **Soft Delete** | 물리 삭제 없음, `deleted_at` 필드 활용 |
| **타임스탬프** | 모든 테이블에 `created_at`, `updated_at` 포함 |
| **UUID** | 외부 노출 ID는 UUID, 내부 PK는 AUTO_INCREMENT |

### 5.2 인덱싱 전략

| 테이블 | 인덱스 | 용도 |
|--------|--------|------|
| `cages` | `(rack_id, position)` | 랙별 케이지 조회 |
| `assignments` | `(cage_id, assigned_date)` | 케이지별 이력 조회 |
| `assignments` | `(professor_id, assigned_date)` | 교수별 이력 조회 |
| `assignments` | `(assigned_date)` | 일별 리포트 |

---

## 6. 접근제어 및 권한 모델

### 6.1 역할 정의

| 역할 | 코드 | 설명 |
|------|------|------|
| **관리자** | `admin` | 모든 권한 (설정, 리포트, 케이지 관리) |
| **연구원** | `researcher` | 케이지 배정/해제만 가능 |

### 6.2 권한 매트릭스

| 기능 | admin | researcher |
|------|-------|------------|
| 케이지 배정/해제 | ✅ | ✅ |
| 랙 설정 | ✅ | ❌ |
| 교수 관리 | ✅ | ❌ |
| 대시보드 조회 | ✅ | ❌ |
| 리포트 다운로드 | ✅ | ❌ |
| 사용자 관리 | ✅ | ❌ |

---

## 7. 데이터 생명주기

### 7.1 수집 원칙

| 원칙 | 설명 |
|------|------|
| **최소 수집** | 서비스 운영에 필수적인 정보만 수집 |
| **목적 명시** | 수집 시 용도 명시 (케이지 관리, 과금) |

### 7.2 보존 기간

| 데이터 유형 | 보존 기간 | 근거 |
|-------------|-----------|------|
| 케이지 배정 기록 | 영구 | 과금 및 감사 추적 |
| 사용자 계정 | 탈퇴 후 1년 | 분쟁 대응 |
| 액세스 로그 | 90일 | 보안 감사 |

### 7.3 삭제/익명화 경로

| 단계 | 설명 |
|------|------|
| 1. 삭제 요청 | 관리자가 사용자 삭제 요청 |
| 2. Soft Delete | `deleted_at` 타임스탬프 기록 |
| 3. 익명화 | 1년 후 개인정보 익명화 (이름 → "탈퇴회원") |
| 4. 기록 보존 | 배정 기록은 익명 상태로 영구 보존 |
